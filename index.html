<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è·¨è¯­ç•ŒÂ·æ™ºèƒ½æœç´¢</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    /* é»˜è®¤æ·±è‰²ä¸»é¢˜ */
    :root {
      --primary-color: #00f3ff;
      --hover-color: #00b4d2;
      --visited-color: #ffd700;
      --clicked-color: #FF4500; /* ç‚¹å‡»åçš„é¢œè‰² */
      --background-dark: linear-gradient(135deg, #0f0c29 0%, #2a0845 50%, #0f0c29 100%);
      --container-bg: rgba(255, 255, 255, 0.08);
      --neon-shadow: 0 0 15px var(--primary-color);
      --glass-border: 1px solid rgba(255,255,255,0.15);
      --transition-speed: 0.3s;
    }
    /* Light-mode */
    body.light-mode {
      --primary-color: #1a73e8;
      --hover-color: #1558b0;
      --background-dark: #e8eaed;
      --container-bg: #ffffff;
      --neon-shadow: 0 0 8px rgba(0, 0, 0, 0.1);
      --glass-border: 1px solid #dadce0;
      color: #202124;
    }
    body.light-mode h1 { color: var(--primary-color); text-shadow: none; }
    body.light-mode .input-group input { background: #f1f3f4; border: 1px solid #dadce0; color: #202124; }
    body.light-mode .autocomplete-list { background: #ffffff; color: #202124; }
    body.light-mode select { background: #f1f3f4; border: 1px solid #dadce0; color: #202124; }
    body.light-mode button { background: var(--primary-color); color: #ffffff; border: none; }
    body.light-mode button:hover { background: var(--hover-color); }
    body.light-mode .history-item { background: #f1f3f4; color: #202124; border: 1px solid #dadce0; }
    body.light-mode #history h3,
    body.light-mode #favorites h3,
    body.light-mode #uiSettings h3 { color: #202124; }
    body.light-mode .modal-content { background: #ffffff; border: 1px solid #dadce0; color: #202124; }
    body.light-mode .modal-close { color: var(--primary-color); }
    /* å…¨å±€æ ·å¼ */
    * { box-sizing: border-box; }
    html, body { margin: 0; overflow-x: hidden; }
    body { background: var(--background-dark); font-family: 'Poppins', sans-serif; min-height: 100vh; }
    /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
    .container::-webkit-scrollbar,
    #output::-webkit-scrollbar,
    #historyList::-webkit-scrollbar,
    #favoritesList::-webkit-scrollbar { width: 10px; }
    .container::-webkit-scrollbar-track,
    #output::-webkit-scrollbar-track,
    #historyList::-webkit-scrollbar-track,
    #favoritesList::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.3); border-radius: 10px;
    }
    .container::-webkit-scrollbar-thumb,
    #output::-webkit-scrollbar-thumb,
    #historyList::-webkit-scrollbar-thumb,
    #favoritesList::-webkit-scrollbar-thumb {
      background: var(--primary-color); border-radius: 10px; box-shadow: 0 0 5px var(--primary-color);
    }
    .container,
    #output,
    #historyList,
    #favoritesList { scrollbar-width: thin; scrollbar-color: var(--primary-color) rgba(0, 0, 0, 0.3); }
    /* åŠ¨ç”»èƒŒæ™¯ */
    body::before {
      content: ''; position: absolute; width: 200%; height: 200%;
      background: linear-gradient(45deg, transparent 48%, rgba(0, 243, 255, 0.1) 50%, transparent 52%);
      animation: gridAnim 20s linear infinite; z-index: -1;
    }
    @keyframes gridAnim {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
    /* ä¸»è¦å®¹å™¨ */
    .container {
      background: var(--container-bg); backdrop-filter: blur(12px);
      border: var(--glass-border); border-radius: 16px; box-shadow: var(--neon-shadow);
      padding: 2rem; width: 90%; max-width: 680px; max-height: 90vh;
      overflow-y: auto; margin: 1rem auto; position: relative; z-index: 1;
    }
    h1 {
      font-family: 'Orbitron', sans-serif; font-weight: 700;
      color: var(--primary-color); text-shadow: 0 0 20px rgba(0, 243, 255, 0.5);
      letter-spacing: 2px; margin-bottom: 1.5rem; position: relative; padding-bottom: 0.5rem;
      text-align: center;
    }
    h1::after {
      content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
      width: 120px; height: 3px; background: linear-gradient(90deg, transparent, var(--primary-color), transparent);
    }
    /* è¾“å…¥åŒº */
    #inputWrapper { margin-bottom: 1rem; position: relative; }
    .input-group { display: flex; gap: 0.8rem; position: relative; }
    .input-group input {
      flex: 1; padding: 0.8rem 1.2rem; background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff; font-size: 1rem;
      transition: border-color var(--transition-speed);
    }
    .input-group input:focus { outline: none; border-color: var(--primary-color); box-shadow: var(--neon-shadow); }
    /* å¢åŠ è¯­éŸ³è¾“å…¥æŒ‰é’® */
    #voiceBtn {
      padding: 0.8rem; background: transparent; border: none; font-size: 1.2rem; cursor: pointer;
    }
    /* æ–°å¢è¯­éŸ³çŠ¶æ€åé¦ˆ */
    #voiceStatus {
      color: #fff;
      text-align: center;
      margin-top: 10px;
      font-size: 0.9rem;
    }
    /* æ–°å¢è¯­éŸ³æç¤ºï¼šè¿™é‡Œç»™å‡ºäº†æ›´å¤šå¯èƒ½çš„æç¤ºè¯ï¼Œä¾›ç”¨æˆ·å‚è€ƒ */
    #voiceTip {
      color: rgba(255,255,255,0.8);
      font-size: 0.85rem;
      margin-top: 5px;
      text-align: center;
      line-height: 1.4;
    }
    /* è‡ªåŠ¨è¡¥å…¨åˆ—è¡¨ */
    .autocomplete-list {
      position: absolute; top: calc(100% + 5px); left: 0; right: 0;
      background: rgba(0,0,0,0.8); border-radius: 8px; max-height: 150px; overflow-y: auto; z-index: 1000; display: none;
    }
    .autocomplete-item { padding: 0.8rem; cursor: pointer; transition: background var(--transition-speed); color: #fff; }
    .autocomplete-item:hover, .autocomplete-item:focus { background: rgba(0,243,255,0.1); }
    #inputHint { color: rgba(255,255,255,0.7); font-size: 0.9rem; margin: 0.5rem 0 1.5rem; }
    /* æŒ‰é’® */
    button {
      padding: 0.8rem 1.5rem; border: none; border-radius: 8px;
      background: linear-gradient(135deg, var(--primary-color), var(--hover-color));
      color: #000; font-family: 'Orbitron', sans-serif; font-weight: 700; cursor: pointer;
      transition: background var(--transition-speed); position: relative; overflow: hidden;
    }
    button:focus { outline: none; box-shadow: var(--neon-shadow); }
    button::after {
      content: ''; position: absolute; top: -50%; left: -50%;
      width: 200%; height: 200%; background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.2) 50%, transparent 70%);
      transform: rotate(45deg); animation: buttonGlow 3s infinite linear; pointer-events: none;
    }
    @keyframes buttonGlow { 0% { transform: translateX(-100%) rotate(45deg); } 100% { transform: translateX(100%) rotate(45deg); } }
    /* ç‚¹å‡»åçŠ¶æ€ */
    .clicked { background-color: var(--clicked-color) !important; color: #fff !important; }
    /* æœç´¢å¼•æ“ä¸ç¿»è¯‘å¼•æ“é€‰æ‹© */
    .search-engine-group, .translation-engine-group {
      display: grid; grid-template-columns: 1fr auto; gap: 0.8rem; align-items: center; margin: 1.5rem 0;
    }
    select { width: 100%; padding: 0.8rem; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff; appearance: none; }
    /* é«˜çº§æœç´¢è®¾ç½®åŒºåŸŸ */
    #advancedOptions {
      background: rgba(0,0,0,0.15); padding: 1rem; border-radius: 8px; margin: 1rem 0; color: #fff; display: none;
    }
    #advancedOptions h3 { margin-top: 0; }
    #advancedOptions label { display: block; margin: 0.5rem 0; }
    /* ç•Œé¢è®¾ç½®åŒºåŸŸ */
    #uiSettings {
      background: rgba(0,0,0,0.15); padding: 1rem; border-radius: 8px; margin: 1rem auto; color: #fff; display: none; max-width: 500px;
    }
    #uiSettings h3 { margin-top: 0; }
    #uiSettings label { display: block; margin: 0.5rem 0; }
    /* â€œæ˜¾ç¤ºç•Œé¢è®¾ç½®â€æŒ‰é’®ï¼ˆä¿æŒåœ¨ä¸»å®¹å™¨å†…ï¼‰ */
    #toggleUIBtn {
      background: transparent; border: none; color: var(--primary-color); font-size: 1rem; cursor: pointer;
      margin-bottom: 0.5rem; text-decoration: underline;
    }
    /* ç¿»è¯‘ç»“æœå¡ç‰‡æ ·å¼ */
    .translation-item {
      background: rgba(0,0,0,0.2); border: 1px solid rgba(0,243,255,0.1); border-radius: 8px;
      padding: 1rem; transition: transform var(--transition-speed); color: #fff;
    }
    .translation-item:hover { transform: translateY(-3px); box-shadow: var(--neon-shadow); }
    .translation-item .search-link {
      display: inline-block; margin-top: 0.5rem; color: var(--primary-color); text-decoration: none;
      transition: color var(--transition-speed), background-color var(--transition-speed);
    }
    .translation-item .search-link:hover { color: var(--hover-color); }
    .translation-item .favorite-button {
      margin-top: 0.5rem; background: transparent; border: 1px solid var(--primary-color);
      color: var(--primary-color); border-radius: 4px; cursor: pointer; padding: 0.3rem 0.6rem;
      transition: background var(--transition-speed), color var(--transition-speed);
    }
    .translation-item .favorite-button:hover { background: var(--primary-color); color: #000; }
    /* æ”¶è—ç»“æœä¸­â€œé¢„è§ˆâ€æ–‡å­—è°ƒæ•´ */
    .history-item .search-link {
      display: inline-block; margin-top: 0.5rem; color: #fff; text-decoration: none;
      transition: color var(--transition-speed); font-weight: bold;
    }
    .history-item .search-link:hover { color: var(--visited-color); }
    /* å†å²è®°å½•ä¸æ”¶è— */
    #history h3, #favorites h3 { color: #fff; margin-bottom: 0.5rem; }
    .history-item {
      padding: 0.8rem; margin: 0.3rem 0; background: rgba(0,0,0,0.2); border-radius: 6px;
      cursor: pointer; transition: background var(--transition-speed);
      display: flex; justify-content: space-between; align-items: center; color: #fff;
    }
    .history-item:hover { background: rgba(0,243,255,0.1); }
    .delete-history {
      background: transparent; border: none; color: var(--primary-color); font-size: 1.2rem;
      cursor: pointer; padding: 0; transition: color var(--transition-speed);
    }
    .delete-history:hover { color: var(--hover-color); }
    #historyList, #favoritesList { max-height: 200px; overflow-y: auto; }
    /* loading spinner */
    #loadingSpinner { display: none; text-align: center; margin: 1rem 0; }
    .spinner {
      width: 40px; height: 40px; border: 4px solid rgba(0,243,255,0.2);
      border-top: 4px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    /* æ¨¡æ€æ¡† */
    .modal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7); z-index: 1001; justify-content: center; align-items: center;
      animation: fadeIn 0.3s;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .modal-content {
      background: var(--container-bg); backdrop-filter: blur(12px); border: var(--glass-border);
      border-radius: 16px; padding: 2rem; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;
      position: relative;
    }
    .modal-close {
      position: absolute; top: 1rem; right: 1rem; background: transparent; border: none;
      color: var(--primary-color); font-size: 1.5rem; cursor: pointer;
    }
    .modal h2 { margin-top: 0; text-align: center; color: var(--primary-color); }
    #configList label { display: block; margin: 0.5rem 0; color: #fff; }
    /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
    @media (max-width: 600px) {
      .container { padding: 1rem; width: 95%; }
      .input-group { flex-direction: column; }
      button { width: 100%; margin-top: 0.5rem; }
      .modal-content { padding: 1rem; max-height: 90vh; }
    }
    /* æœç´¢ç»“æœåŒºåŸŸå¹³é“ºå±•ç¤º */
    #output {
      width: 100%; max-width: 100%; padding: 1rem; overflow-y: auto; overflow-x: hidden;
      box-sizing: border-box; background: rgba(0,0,0,0.1); display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;
    }
    /* å½“æœç´¢ç»“æœä¸ºç©ºæ—¶ï¼Œéšè—è¯¥åŒºåŸŸ */
    #output:empty { display: none; }
  </style>
</head>
<body>
  <main class="container">
    <h1>è·¨è¯­ç•ŒÂ·æ™ºèƒ½æœç´¢</h1>
    
    <section id="inputWrapper">
      <div class="input-group">
        <input type="text" id="inputText" placeholder="è¾“å…¥ä¸­æ–‡å†…å®¹... " aria-label="æœç´¢å…³é”®è¯">
        <!-- æ–°å¢è¯­éŸ³è¾“å…¥æŒ‰é’® -->
        <button id="voiceBtn" title="è¯­éŸ³è¾“å…¥">ğŸ¤</button>
        <button id="clearInputButton" aria-label="æ¸…ç©ºè¾“å…¥">âŸ³ æ¸…ç©º</button>
        <div class="autocomplete-list" id="autocompleteList" role="listbox"></div>
      </div>
      <p id="inputHint">è¾“å…¥å…³é”®è¯åç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è¿›è¡Œæ™ºèƒ½æœç´¢</p>
      <!-- æ–°å¢è¯­éŸ³çŠ¶æ€åé¦ˆ -->
      <div id="voiceStatus"></div>
      <!-- æ–°å¢è¯­éŸ³æç¤ºï¼šåˆ—ä¸¾äº†å°½å¯èƒ½å¤šçš„æç¤ºè¯ï¼Œå¸®åŠ©ç”¨æˆ·å¿«é€ŸæŒæ¡æŒ‡ä»¤ -->
      <div id="voiceTip">
        è¯­éŸ³æç¤ºè¯ï¼šä¾‹å¦‚ "å¤©æ°”ç”¨è°·æ­Œæµè§ˆå™¨æœç´¢"ã€"æœ€æ–°æ–°é—»å¿…åº”æœç´¢"ã€"ç¿»è¯‘æˆæ‰€æœ‰è¯­è¨€æœç´¢å’–å•¡"ã€"ä½“è‚²æ–°é—»è°·æ­Œæœç´¢"ã€"è°·æ­Œæœç´¢ä¸–ç•Œæ¯æ–°é—»"ã€"å¤©æ°”ç”¨è°·æ­Œæµè§ˆå™¨æœç´¢"ã€"å¤©æ°”é€šè¿‡ç¾å›½æœç´¢"ã€"åœ¨è°·æ­Œä¸­æœç´¢ç¾é£Ÿæ¨è" ç­‰ç­‰ã€‚
      </div>
    </section>

    <section class="search-engine-group">
      <select id="searchEngineSelect">
        <option value="all">é€‰æ‹©æœç´¢å¼•æ“ï¼ˆé»˜è®¤æœç´¢å…¨éƒ¨ç»“æœï¼‰</option>
      </select>
      <button id="configBtn" aria-label="é…ç½®æœç´¢å¼•æ“">âš™ï¸ å¼•æ“é…ç½®</button>
    </section>

    <section class="translation-engine-group">
      <select id="translationEngineSelect">
        <option value="mymemory">MyMemory ç¿»è¯‘</option>
        <option value="google">Google ç¿»è¯‘</option>
      </select>
    </section>

    <!-- é«˜çº§æœç´¢è®¾ç½® -->
    <button id="toggleAdvancedBtn">æ˜¾ç¤ºé«˜çº§æœç´¢è®¾ç½®</button>
    <section id="advancedOptions">
      <h3>é«˜çº§æœç´¢è®¾ç½®</h3>
      <div>
        <label>æ—¶é—´ç­›é€‰:
          <select id="timeFilter">
            <option value="">ä¸é™æ—¶é—´</option>
            <option value="24h">è¿‡å»24å°æ—¶</option>
            <option value="week">è¿‡å»ä¸€å‘¨</option>
            <option value="month">è¿‡å»ä¸€ä¸ªæœˆ</option>
            <option value="year">è¿‡å»ä¸€å¹´</option>
          </select>
        </label>
      </div>
      <div>
        <label>åœ°åŒºç­›é€‰:
          <select id="regionFilter">
            <option value="">ä¸é™åœ°åŒº</option>
            <option value="us">ç¾å›½</option>
            <option value="cn">ä¸­å›½</option>
            <option value="uk">è‹±å›½</option>
          </select>
        </label>
      </div>
      <div>
        <label>è¯­è¨€ç­›é€‰:
          <select id="languageFilter">
            <option value="">ä¸é™è¯­è¨€</option>
            <option value="en">è‹±æ–‡</option>
            <option value="zh">ä¸­æ–‡</option>
            <option value="es">è¥¿ç­ç‰™è¯­</option>
          </select>
        </label>
      </div>
    </section>

    <!-- ç¿»è¯‘æŒ‰é’® -->
    <button id="translateButton" aria-label="æ™ºèƒ½ç¿»è¯‘æœç´¢">ğŸš€ æ™ºèƒ½ç¿»è¯‘æœç´¢</button>

    <div id="loadingSpinner">
      <div class="spinner"></div>
    </div>

    <section id="history">
      <h3>æœ€è¿‘æœç´¢</h3>
      <div id="historyList"></div>
      <button id="clearHistoryButton">æ¸…ç©ºå†å²è®°å½•</button>
    </section>

    <section id="favorites">
      <h3>æ”¶è—çš„æœç´¢ç»“æœ</h3>
      <div id="favoritesList"></div>
      <button id="clearFavoritesButton">æ¸…ç©ºæ”¶è—</button>
    </section>

    <!-- ç•Œé¢è®¾ç½®åŒºåŸŸåŠæ˜¾ç¤ºç•Œé¢è®¾ç½®æŒ‰é’®ï¼ˆä¿æŒåœ¨ä¸»å®¹å™¨å†…ï¼‰ -->
    <button id="toggleUIBtn">æ˜¾ç¤ºç•Œé¢è®¾ç½®</button>
    <section id="uiSettings">
      <h3>ç•Œé¢è®¾ç½®</h3>
      <button id="toggleThemeButton">åˆ‡æ¢ä¸»é¢˜</button>
      <label>
        å­—ä½“å¤§å°:
        <input type="range" id="fontSizeRange" min="12" max="24" value="16">
      </label>
    </section>
  </main>

  <!-- æœç´¢ç»“æœåŒºåŸŸå¹³é“ºå±•ç¤º -->
  <section id="output">
    <!-- æœç´¢ç»“æœå°†ä»¥å¹³é“ºçš„æ–¹å¼å±•ç¤ºåœ¨è¿™é‡Œ -->
  </section>

  <!-- æ¨¡æ€æ¡† -->
  <div class="modal" id="configModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-content">
      <button class="modal-close" id="modalClose" aria-label="å…³é—­">&times;</button>
      <h2 id="modalTitle">è‡ªå®šä¹‰æœç´¢å¼•æ“</h2>
      <div id="configList"></div>
      <button id="saveConfigBtn">ä¿å­˜é…ç½®</button>
    </div>
  </div>

  <script>
    (function(){
      'use strict';
      
      // åˆå§‹æ—¶éšè—æ•´ä¸ªé¡µé¢çš„å‚ç›´æ»šåŠ¨æ¡
      document.documentElement.style.overflowY = "hidden";
      document.body.style.overflowY = "hidden";

      // é˜²æŠ–å‡½æ•°
      function debounce(func, delay) {
        let timer;
        return function(...args) {
          clearTimeout(timer);
          timer = setTimeout(() => { func.apply(this, args); }, delay);
        };
      }

      // è¯­éŸ³è¾“å…¥ä¸è¯­éŸ³æ§åˆ¶æ‰©å±•ï¼ˆæ”¹è¿›ç‰ˆï¼‰
      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        recognition.lang = 'zh-CN';
        recognition.continuous = false;
        recognition.interimResults = true; // å¼€å¯ä¸­é—´ç»“æœåé¦ˆ

        // æ›´æ–°çŠ¶æ€ä¿¡æ¯
        recognition.onstart = function() {
          document.getElementById('voiceStatus').textContent = 'å¼€å§‹è¯­éŸ³è¯†åˆ«...';
        };
        recognition.onend = function() {
          if(!document.getElementById('voiceStatus').textContent.includes('æ­£åœ¨è¯†åˆ«')) {
            document.getElementById('voiceStatus').textContent = '';
          }
        };

        document.getElementById('voiceBtn').addEventListener('click', function(){
          recognition.start();
        });

        // å®šä¹‰æ›´å¤šè¯­éŸ³æŒ‡ä»¤åŒ¹é…æ¨¡å¼ï¼ˆè¿™é‡Œå¢åŠ äº†æ›´å¤šå¯èƒ½çš„å˜ä½“ï¼‰
        const patterns = [
          // æ–°å¢ï¼šåŒ¹é…æ ¼å¼ "è°·æ­Œæœç´¢ä¸–ç•Œæ¯æ–°é—»"
          { regex: /^(è°·æ­Œ|google)æœç´¢(.+)$/, hasEngine: true },
          { regex: /(.+?)ç”¨(.+?)æµè§ˆå™¨æœç´¢/, hasEngine: true },
          { regex: /æœç´¢(.+?)ç”¨(.+?)æµè§ˆå™¨/, hasEngine: true },
          { regex: /(.+?)é€šè¿‡(.+?)æœç´¢/, hasEngine: true },
          { regex: /(.+?)é€‰(.+?)æœç´¢/, hasEngine: true },
          { regex: /^(?:è¯·\s*)?æœç´¢\s*(.+)/, hasEngine: false },
          { regex: /^(?:è¯·\s*)?(?:å¸®æˆ‘\s*)?(?:æœç´¢|æŸ¥æ‰¾|æ‰¾ä¸€ä¸‹)\s*(.+?)(?:çš„(?:ç»“æœ|ä¿¡æ¯))?$/, hasEngine: false },
          { regex: /(.+?)åœ¨(.+?)ä¸Šæœç´¢/, hasEngine: true },
          { regex: /^(?:è¯·\s*)?(?:ç»™æˆ‘\s*)?(?:æŸ¥æ‰¾|æœç´¢)(?:ä¸€ä¸‹)?\s*(.+)$/, hasEngine: false },
          { regex: /^(?:è¯·\s*)?(?:å¸®æˆ‘\s*)?(?:æ‰¾ä¸€æ‰¾|æœä¸€æœ)\s*(.+?)(?:çš„(?:ç»“æœ|è¯¦æƒ…))?$/, hasEngine: false },
          { regex: /^(?:è¯·\s*)?(?:å¸®æˆ‘\s*)?(?:æ‰“å¼€|æŸ¥æ‰¾)\s*(.+?)(?:çš„)?\s*(?:ç½‘é¡µ|ä¿¡æ¯)$/, hasEngine: false },
          { regex: /^(?:è¯·\s*)?(?:å¸®æˆ‘)?(?:æŸ¥æŸ¥|çœ‹çœ‹|æœç´¢ä¸€ä¸‹|æ‰¾ä¸€ä¸‹)\s*(.+?)(?:çš„(?:ä¿¡æ¯|è¯¦æƒ…))?$/, hasEngine: false },
          { regex: /^(?:è¯·é—®|è¯·å¸®æˆ‘|æˆ‘è¦çŸ¥é“)\s*(.+?)(?:çš„(?:ä¿¡æ¯|æƒ…å†µ|è¯¦æƒ…))?$/, hasEngine: false },
          { regex: /^(.+?)çš„(?:æ–°é—»|æŠ¥é“)$/, hasEngine: false },
          // ç”¨æˆ·å…ˆè¯´æœç´¢å¼•æ“ï¼Œå†è¯´æŸ¥è¯¢å†…å®¹ï¼Œå¦‚ï¼šâ€œç™¾åº¦æŸ¥è¯¢å¤©æ°”é¢„æŠ¥â€
          { regex: /^(.+?)\s*æŸ¥è¯¢\s*(.+)$/, hasEngine: true },
          // ç±»ä¼¼â€œåœ¨ç™¾åº¦ä¸­æŸ¥æ‰¾å¤©æ°”é¢„æŠ¥â€
          { regex: /^(?:åœ¨)?(.+?)\s*(?:ä¸­)?\s*(?:æœç´¢|æŸ¥æ‰¾|æŸ¥è¯¢)\s*(.+)$/, hasEngine: true },
          // æ–°å¢ï¼šåŒ¹é…â€œå…³é”®è¯+ç™¾åº¦æœç´¢â€æˆ–â€œå…³é”®è¯+å¿…åº”æœç´¢â€
          { regex: /^(.+?)(ç™¾åº¦|å¿…åº”|bing)æœç´¢$/, hasEngine: true },
          // æ–°å¢ï¼šæ›´å®½æ³›çš„æ¨¡å¼ï¼ŒåŒ¹é…â€œè¯·æœä¸€ä¸‹â€¦â€ã€â€œå¸®æˆ‘æŸ¥ä¸€ä¸‹â€¦â€ç­‰
          { regex: /^(?:è¯·|å¸®æˆ‘)?\s*(.+?)(?:æŸ¥ä¸€ä¸‹|æœä¸€ä¸‹|æ‰¾ä¸€ä¸‹)$/, hasEngine: false }
        ];

        // å®šä¹‰å¤šè¯­è¨€æœç´¢çš„ç›®æ ‡è¯­è¨€åˆ—è¡¨
        const multiLanguages = [
          { code: 'zh', label: 'ä¸­æ–‡' },
          { code: 'en', label: 'è‹±æ–‡' },
          { code: 'es', label: 'è¥¿ç­ç‰™è¯­' },
          { code: 'fr', label: 'æ³•è¯­' },
          { code: 'de', label: 'å¾·è¯­' },
          { code: 'ja', label: 'æ—¥è¯­' },
          { code: 'ko', label: 'éŸ©è¯­' },
          { code: 'ru', label: 'ä¿„è¯­' },
          { code: 'it', label: 'æ„å¤§åˆ©è¯­' },
          { code: 'pt', label: 'è‘¡è„ç‰™è¯­' }
        ];

        // æ–°å¢å¤šè¯­è¨€æœç´¢åŠŸèƒ½ï¼šå¯¹æŒ‡å®šæŸ¥è¯¢åˆ†åˆ«ç¿»è¯‘æˆå¤šè¯­è¨€åç”Ÿæˆè°·æ­Œæœç´¢é“¾æ¥
        async function multiLanguageSearch(query) {
          dom.loadingSpinner.style.display = 'block';
          try {
            let results = await Promise.all(
              multiLanguages.map(langObj =>
                translateText(query, langObj.code, dom.translationEngineSelect.value)
                  .then(translated => ({
                    label: langObj.label,
                    translated: translated,
                    url: "https://www.google.com/search?q=" + encodeURIComponent(translated)
                  }))
              )
            );
            dom.outputDiv.innerHTML = results.map(result => `
              <div class="translation-item">
                <p>${result.label}: ${escapeHtml(result.translated)}</p>
                <a class="search-link" href="${result.url}" target="_blank">è°·æ­Œæœç´¢</a>
              </div>
            `).join('');
          } catch (error) {
            alert("å¤šè¯­è¨€æœç´¢å‡ºé”™ï¼š" + error.message);
          } finally {
            dom.loadingSpinner.style.display = 'none';
          }
        }

        recognition.onresult = function(event) {
          let interimTranscript = '';
          let finalTranscript = '';
          for (let i = event.resultIndex; i < event.results.length; i++) {
            if (event.results[i].isFinal) {
              finalTranscript += event.results[i][0].transcript;
            } else {
              interimTranscript += event.results[i][0].transcript;
            }
          }
          if (interimTranscript) {
            document.getElementById('voiceStatus').textContent = 'æ­£åœ¨è¯†åˆ«ï¼š' + interimTranscript;
          }
          if (finalTranscript) {
            document.getElementById('voiceStatus').textContent = '';
            let transcript = finalTranscript.trim();
            // å¦‚æœåŒ…å«â€œç¿»è¯‘æˆæ‰€æœ‰è¯­è¨€æœç´¢â€ï¼Œåˆ™è§¦å‘å¤šè¯­è¨€æœç´¢ï¼ˆä¹Ÿå¯é€šè¿‡å•ç‹¬æŒ‡ä»¤è§¦å‘ï¼‰
            if (transcript.includes("ç¿»è¯‘æˆæ‰€æœ‰è¯­è¨€æœç´¢")) {
              let query = transcript.replace("ç¿»è¯‘æˆæ‰€æœ‰è¯­è¨€æœç´¢", "").trim();
              multiLanguageSearch(query);
              return;
            }
            let query = "";
            let engineName = "";
            let matched = false;
            for (let item of patterns) {
              let match = transcript.match(item.regex);
              if (match) {
                if (item.hasEngine && match.length >= 3) {
                  query = match[1].trim();
                  engineName = match[2].trim();
                } else {
                  query = match[match.length - 1].trim();
                  engineName = "";
                }
                matched = true;
                break;
              }
            }
            // å¦‚æœåŒ¹é…åˆ°æŒ‡ä»¤ä¸­å«æœ‰ç‰¹å®šæœç´¢å¼•æ“è¯ï¼ˆå¦‚â€œè°·æ­Œâ€ã€â€œç™¾åº¦â€ã€â€œå¿…åº”â€ï¼‰ï¼Œåˆ™è°ƒç”¨å¤šè¯­è¨€æœç´¢
            if (matched && engineName && (engineName === "è°·æ­Œ" || engineName.toLowerCase() === "google" ||
                engineName === "ç™¾åº¦" || engineName === "å¿…åº”" || engineName.toLowerCase() === "bing")) {
              multiLanguageSearch(query);
              return;
            }
            if (query && engineName) {
              document.getElementById('inputText').value = query;
              const engineMapping = {
                "ç¾å›½": "us",
                "è‹±å›½": "gb",
                "æ¾³å¤§åˆ©äºš": "au",
                "åŠ æ‹¿å¤§": "ca",
                "å°åº¦": "in",
                "è¥¿ç­ç‰™": "es",
                "å¢¨è¥¿å“¥": "mx",
                "å·´è¥¿": "br",
                "é˜¿æ ¹å»·": "ar",
                "æ™ºåˆ©": "cl",
                "æ³•å›½": "fr",
                "å¾·å›½": "de",
                "æ„å¤§åˆ©": "it",
                "è·å…°": "nl",
                "ä¿„ç½—æ–¯": "ru",
                "ä¹Œå…‹å…°": "ua",
                "æ³¢å…°": "pl",
                "æ·å…‹": "cz",
                "åŒˆç‰™åˆ©": "hu",
                "ç½—é©¬å°¼äºš": "ro",
                "åœŸè€³å…¶": "tr",
                "ä¼Šæœ—": "ir",
                "æ²™ç‰¹": "sa",
                "æ—¥æœ¬": "jp",
                "éŸ©å›½": "kr",
                "æ³°å›½": "th",
                "è¶Šå—": "vi",
                "å°åº¦å°¼è¥¿äºš": "id",
                "é©¬æ¥è¥¿äºš": "my",
                "è²å¾‹å®¾": "ph",
                "æ–°åŠ å¡": "sg",
                "å—é": "za",
                "åŸƒåŠ": "eg",
                "è‚¯å°¼äºš": "ke",
                "å°¼æ—¥åˆ©äºš": "ng",
                "å·´åŸºæ–¯å¦": "pk",
                "å­ŸåŠ æ‹‰å›½": "bd",
                "ç‘å…¸": "se",
                "ä¸¹éº¦": "dk",
                "èŠ¬å…°": "fi",
                "æŒªå¨": "no",
                "ç‘å£« (å¾·è¯­)": "ch-de",
                "ç‘å£« (æ³•è¯­)": "ch-fr",
                "ç‘å£« (æ„å¤§åˆ©è¯­)": "ch-it",
                "æ–°è¥¿å…°": "nz",
                "é¦™æ¸¯": "google-hk",
                "å°æ¹¾": "google-tw",
                "ä»¥è‰²åˆ—": "walla"
              };
              if(engineMapping[engineName]) {
                document.getElementById('searchEngineSelect').value = engineMapping[engineName];
              }
              document.getElementById('translateButton').click();
            } else if (query) {
              document.getElementById('inputText').value = query;
            } else {
              document.getElementById('inputText').value = transcript;
            }
          }
        };

        recognition.onerror = function(event) {
          console.error('è¯­éŸ³è¯†åˆ«é”™è¯¯ï¼š', event.error);
          document.getElementById('voiceStatus').textContent = 'è¯†åˆ«é”™è¯¯ï¼š' + event.error;
        };
      } else {
        document.getElementById('voiceBtn').style.display = 'none';
        console.warn('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«');
      }
      
      // é™æ€å»ºè®®ã€çƒ­é—¨å…³é”®è¯åŠæ‹¼å†™çº é”™æ˜ å°„
      const staticSuggestions = ['ä¸­æ–‡', 'ç¿»è¯‘', 'æœç´¢', 'è·¨è¯­ç•Œ', 'æ™ºèƒ½'];
      const trendingSuggestions = ['çƒ­é—¨æœç´¢', 'æœ€æ–°èµ„è®¯', 'å®æ—¶åŠ¨æ€'];
      const spellingCorrections = {
        "æœæœ": "æœç´¢",
        "ç¿»è¯‘é”™": "ç¿»è¯‘é”™è¯¯",
        "è·¨è¯­": "è·¨è¯­ç•Œ",
        "æ™ºæœ": "æ™ºèƒ½æœç´¢"
      };
      function getSpellingSuggestions(text) {
        let suggestions = [];
        for (let key in spellingCorrections) {
          if (text.includes(key)) {
            suggestions.push(spellingCorrections[key]);
          }
        }
        return suggestions;
      }

      // æœç´¢å¼•æ“é…ç½®ï¼ˆç¤ºä¾‹ï¼Œä»…ä¿ç•™éƒ¨åˆ†é…ç½®ï¼‰
      const searchEngines = {
        'us': { name: 'Google ç¾å›½', url: 'https://www.google.com/search?q=', lang: 'en', enabled: true },
        'gb': { name: 'Google è‹±å›½', url: 'https://www.google.co.uk/search?q=', lang: 'en', enabled: true },
        'au': { name: 'Google æ¾³å¤§åˆ©äºš', url: 'https://www.google.com.au/search?q=', lang: 'en', enabled: true },
        'ca': { name: 'Google åŠ æ‹¿å¤§', url: 'https://www.google.ca/search?q=', lang: 'en', enabled: true },
        'in': { name: 'Google å°åº¦', url: 'https://www.google.co.in/search?q=', lang: 'hi', enabled: true },
        'es': { name: 'Google è¥¿ç­ç‰™', url: 'https://www.google.es/search?q=', lang: 'es', enabled: true },
        'mx': { name: 'Google å¢¨è¥¿å“¥', url: 'https://www.google.com.mx/search?q=', lang: 'es', enabled: true },
        'br': { name: 'Google å·´è¥¿', url: 'https://www.google.com.br/search?q=', lang: 'pt', enabled: true },
        'ar': { name: 'Google é˜¿æ ¹å»·', url: 'https://www.google.com.ar/search?q=', lang: 'es', enabled: true },
        'cl': { name: 'Google æ™ºåˆ©', url: 'https://www.google.cl/search?q=', lang: 'es', enabled: true },
        'fr': { name: 'Google æ³•å›½', url: 'https://www.google.fr/search?q=', lang: 'fr', enabled: true },
        'de': { name: 'Google å¾·å›½', url: 'https://www.google.de/search?q=', lang: 'de', enabled: true },
        'it': { name: 'Google æ„å¤§åˆ©', url: 'https://www.google.it/search?q=', lang: 'it', enabled: true },
        'nl': { name: 'Google è·å…°', url: 'https://www.google.nl/search?q=', lang: 'nl', enabled: true },
        'ru': { name: 'Yandex ä¿„ç½—æ–¯', url: 'https://yandex.ru/search/?text=', lang: 'ru', enabled: true },
        'ua': { name: 'Google ä¹Œå…‹å…°', url: 'https://www.google.com.ua/search?q=', lang: 'uk', enabled: true },
        'pl': { name: 'Google æ³¢å…°', url: 'https://www.google.pl/search?q=', lang: 'pl', enabled: true },
        'cz': { name: 'Seznam æ·å…‹', url: 'https://www.seznam.cz/hledat?q=', lang: 'cs', enabled: true },
        'hu': { name: 'Google åŒˆç‰™åˆ©', url: 'https://www.google.hu/search?q=', lang: 'hu', enabled: true },
        'ro': { name: 'Google ç½—é©¬å°¼äºš', url: 'https://www.google.ro/search?q=', lang: 'ro', enabled: true },
        'tr': { name: 'Google åœŸè€³å…¶', url: 'https://www.google.com.tr/search?q=', lang: 'tr', enabled: true },
        'ir': { name: 'Parsijoo ä¼Šæœ—', url: 'https://www.parsijoo.ir/web/search?q=', lang: 'fa', enabled: true },
        'sa': { name: 'Google æ²™ç‰¹', url: 'https://www.google.com.sa/search?q=', lang: 'ar', enabled: true },
        'jp': { name: 'Yahoo! æ—¥æœ¬', url: 'https://search.yahoo.co.jp/search?p=', lang: 'ja', enabled: true },
        'kr': { name: 'Naver éŸ©å›½', url: 'https://search.naver.com/search.naver?query=', lang: 'ko', enabled: true },
        'th': { name: 'Google æ³°å›½', url: 'https://www.google.co.th/search?q=', lang: 'th', enabled: true },
        'vi': { name: 'Cá»‘c Cá»‘c è¶Šå—', url: 'https://coccoc.com/search#query=', lang: 'vi', enabled: true },
        'id': { name: 'Google å°åº¦å°¼è¥¿äºš', url: 'https://www.google.co.id/search?q=', lang: 'id', enabled: true },
        'my': { name: 'Google é©¬æ¥è¥¿äºš', url: 'https://www.google.com.my/search?q=', lang: 'ms', enabled: true },
        'ph': { name: 'Google è²å¾‹å®¾', url: 'https://www.google.com.ph/search?q=', lang: 'tl', enabled: true },
        'sg': { name: 'Google æ–°åŠ å¡', url: 'https://www.google.com.sg/search?q=', lang: 'en', enabled: true },
        'za': { name: 'Google å—é', url: 'https://www.google.co.za/search?q=', lang: 'en', enabled: true },
        'eg': { name: 'Google åŸƒåŠ', url: 'https://www.google.com.eg/search?q=', lang: 'ar', enabled: true },
        'ke': { name: 'Google è‚¯å°¼äºš', url: 'https://www.google.co.ke/search?q=', lang: 'en', enabled: true },
        'ng': { name: 'Google å°¼æ—¥åˆ©äºš', url: 'https://www.google.com.ng/search?q=', lang: 'en', enabled: true },
        'pk': { name: 'Google å·´åŸºæ–¯å¦', url: 'https://www.google.com.pk/search?q=', lang: 'ur', enabled: true },
        'bd': { name: 'Google å­ŸåŠ æ‹‰å›½', url: 'https://www.google.com.bd/search?q=', lang: 'bn', enabled: true },
        'se': { name: 'Google ç‘å…¸', url: 'https://www.google.se/search?q=', lang: 'sv', enabled: true },
        'dk': { name: 'Google ä¸¹éº¦', url: 'https://www.google.dk/search?q=', lang: 'da', enabled: true },
        'fi': { name: 'Google èŠ¬å…°', url: 'https://www.google.fi/search?q=', lang: 'fi', enabled: true },
        'no': { name: 'Google æŒªå¨', url: 'https://www.google.no/search?q=', lang: 'no', enabled: true },
        'ch-de': { name: 'Google ç‘å£« (å¾·è¯­)', url: 'https://www.google.ch/search?q=', lang: 'de', enabled: true },
        'ch-fr': { name: 'Google ç‘å£« (æ³•è¯­)', url: 'https://www.google.ch/search?q=', lang: 'fr', enabled: true },
        'ch-it': { name: 'Google ç‘å£« (æ„å¤§åˆ©è¯­)', url: 'https://www.google.ch/search?q=', lang: 'it', enabled: true },
        'nz': { name: 'Google æ–°è¥¿å…°', url: 'https://www.google.co.nz/search?q=', lang: 'en', enabled: true },
        'bing': { name: 'Bing ç¾å›½', url: 'https://www.bing.com/search?q=', lang: 'en', enabled: true },
        'duck': { name: 'DuckDuckGo', url: 'https://duckduckgo.com/?q=', lang: 'en', enabled: true },
        'eco': { name: 'Ecosia å¾·å›½', url: 'https://www.ecosia.org/search?q=', lang: 'de', enabled: true },
        'qnt': { name: 'Qwant æ³•å›½', url: 'https://www.qwant.com/?q=', lang: 'fr', enabled: true },
        'sp': { name: 'Startpage è·å…°', url: 'https://www.startpage.com/do/search?q=', lang: 'nl', enabled: true },
        'ask': { name: 'Ask ç¾å›½', url: 'https://www.ask.com/web?q=', lang: 'en', enabled: true },
        'swisscows': { name: 'Swisscows æ¬§æ´²', url: 'https://swisscows.com/web?query=', lang: 'en', enabled: true },
        'mojeek': { name: 'Mojeek è‹±å›½', url: 'https://www.mojeek.com/search?q=', lang: 'en', enabled: true },
        'metager': { name: 'MetaGer å¾·å›½', url: 'https://metager.org/meta/meta.ger3?eingabe=', lang: 'de', enabled: true },
        'yahoo-us': { name: 'Yahoo! ç¾å›½', url: 'https://search.yahoo.com/search?p=', lang: 'en', enabled: true },
        'yahoo-in': { name: 'Yahoo! å°åº¦', url: 'https://in.search.yahoo.com/search?p=', lang: 'hi', enabled: true },
        'aol': { name: 'AOL', url: 'https://search.aol.com/aol/search?q=', lang: 'en', enabled: true },
        'daum': { name: 'Daum éŸ©å›½', url: 'https://search.daum.net/search?q=', lang: 'ko', enabled: true },
        'exalead': { name: 'Exalead', url: 'https://www.exalead.com/search/web/results/?q=', lang: 'en', enabled: true },
        'dogpile': { name: 'Dogpile', url: 'https://www.dogpile.com/serp?q=', lang: 'en', enabled: true },
        'yahoo-tw': { name: 'Yahoo! å°æ¹¾', url: 'https://tw.search.yahoo.com/search?p=', lang: 'en', enabled: true },
        'yahoo-hk': { name: 'Yahoo! é¦™æ¸¯', url: 'https://hk.search.yahoo.com/search?p=', lang: 'en', enabled: true },
        'google-hk': { name: 'Google é¦™æ¸¯', url: 'https://www.google.com.hk/search?q=', lang: 'en', enabled: true },
        'google-tw': { name: 'Google å°æ¹¾', url: 'https://www.google.com.tw/search?q=', lang: 'en', enabled: true },
        'walla': { name: 'Walla! ä»¥è‰²åˆ—', url: 'https://www.walla.co.il/search?query=', lang: 'he', enabled: true },
        'gigablast': { name: 'Gigablast', url: 'https://www.gigablast.com/search?q=', lang: 'en', enabled: true },
        'lycos': { name: 'Lycos', url: 'https://search.lycos.com/web/?q=', lang: 'en', enabled: true },
        'yahoo-us2': { name: 'Yahoo! ç¾å›½ (å¤‡ç”¨)', url: 'https://search.yahoo.com/search?p=', lang: 'en', enabled: true },
        'google-hk2': { name: 'Google é¦™æ¸¯ (å¤‡ç”¨)', url: 'https://www.google.com.hk/search?q=', lang: 'en', enabled: true },
        'google-tw2': { name: 'Google å°æ¹¾ (å¤‡ç”¨)', url: 'https://www.google.com.tw/search?q=', lang: 'en', enabled: true },
        'gigablast2': { name: 'Gigablast (å¤‡ç”¨)', url: 'https://www.gigablast.com/search?q=', lang: 'en', enabled: true }
      };

      const savedSearchEnginesConfig = localStorage.getItem("searchEnginesConfig");
      if (savedSearchEnginesConfig) {
        const savedConfig = JSON.parse(savedSearchEnginesConfig);
        for (const key in savedConfig) {
          if (searchEngines.hasOwnProperty(key)) {
            searchEngines[key].enabled = savedConfig[key].enabled;
          }
        }
      }

      const dom = {
        inputText: document.getElementById("inputText"),
        translateButton: document.getElementById("translateButton"),
        outputDiv: document.getElementById("output"),
        loadingSpinner: document.getElementById("loadingSpinner"),
        historyList: document.getElementById("historyList"),
        clearHistoryButton: document.getElementById("clearHistoryButton"),
        searchEngineSelect: document.getElementById("searchEngineSelect"),
        configBtn: document.getElementById("configBtn"),
        configModal: document.getElementById("configModal"),
        modalClose: document.getElementById("modalClose"),
        configList: document.getElementById("configList"),
        saveConfigBtn: document.getElementById("saveConfigBtn"),
        autocompleteList: document.getElementById("autocompleteList"),
        clearInputButton: document.getElementById("clearInputButton"),
        translationEngineSelect: document.getElementById("translationEngineSelect"),
        timeFilter: document.getElementById("timeFilter"),
        regionFilter: document.getElementById("regionFilter"),
        languageFilter: document.getElementById("languageFilter"),
        favoritesList: document.getElementById("favoritesList"),
        clearFavoritesButton: document.getElementById("clearFavoritesButton"),
        toggleThemeButton: document.getElementById("toggleThemeButton"),
        fontSizeRange: document.getElementById("fontSizeRange"),
        toggleAdvancedBtn: document.getElementById("toggleAdvancedBtn"),
        advancedOptions: document.getElementById("advancedOptions"),
        toggleUIBtn: document.getElementById("toggleUIBtn"),
        uiSettings: document.getElementById("uiSettings")
      };

      let historyData = JSON.parse(localStorage.getItem("history")) || [];
      let favoritesData = JSON.parse(localStorage.getItem("favorites")) || [];

      function escapeHtml(str) {
        return str.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[m]);
      }

      function renderHistory() {
        dom.historyList.innerHTML = historyData.map((item, index) => `
          <div class="history-item" data-index="${index}">
            <span>${escapeHtml(item.text)}</span>
            <button class="delete-history" data-index="${index}" aria-label="åˆ é™¤è¯¥å†å²è®°å½•">Ã—</button>
          </div>
        `).join('');
        dom.clearHistoryButton.style.display = historyData.length ? 'block' : 'none';
      }

      function renderFavorites() {
        dom.favoritesList.innerHTML = favoritesData.map((item, index) => `
          <div class="history-item" data-index="${index}">
            <span>${escapeHtml(item.engine)} - ${escapeHtml(item.query)}</span>
            <a class="search-link" href="${item.url}" target="_blank">é¢„è§ˆ</a>
            <button class="delete-favorite" data-index="${index}" aria-label="åˆ é™¤æ”¶è—">Ã—</button>
          </div>
        `).join('');
        dom.clearFavoritesButton.style.display = favoritesData.length ? 'block' : 'none';
      }

      function saveToHistory(text, language) {
        if (!text) return;
        const exists = historyData.some(item => item.text === text && item.language === language);
        if (!exists) {
          historyData.unshift({ text, language });
          if (historyData.length > 10) historyData.pop();
          localStorage.setItem("history", JSON.stringify(historyData));
          renderHistory();
        }
      }

      function saveFavorite(result) {
        const exists = favoritesData.some(item => item.url === result.url);
        if (!exists) {
          favoritesData.unshift(result);
          localStorage.setItem("favorites", JSON.stringify(favoritesData));
          renderFavorites();
        }
      }

      function buildSearchUrl(engine, query) {
        let url = engine.url + encodeURIComponent(query);
        let params = [];
        if (dom.timeFilter.value) {
          if (engine.url.includes("google")) {
            if (dom.timeFilter.value === "24h") params.push("qdr:d");
            if (dom.timeFilter.value === "week") params.push("qdr:w");
            if (dom.timeFilter.value === "month") params.push("qdr:m");
            if (dom.timeFilter.value === "year") params.push("qdr:y");
          } else {
            params.push("time=" + encodeURIComponent(dom.timeFilter.value));
          }
        }
        if (dom.regionFilter.value) {
          if (engine.url.includes("google")) {
            params.push("cr=country" + dom.regionFilter.value.toUpperCase());
          } else {
            params.push("region=" + encodeURIComponent(dom.regionFilter.value));
          }
        }
        if (dom.languageFilter.value) {
          if (engine.url.includes("google")) {
            params.push("lr=lang_" + dom.languageFilter.value);
          } else {
            params.push("lang=" + encodeURIComponent(dom.languageFilter.value));
          }
        }
        if (params.length > 0) {
          if (engine.url.includes("google")) {
            const tbsParams = params.filter(p => p.startsWith("qdr:"));
            const otherParams = params.filter(p => p.startsWith("cr=") || p.startsWith("lr="));
            if (tbsParams.length > 0) {
              url += "&tbs=" + tbsParams.join(",");
            }
            otherParams.forEach(p => { url += "&" + p; });
          } else {
            url += "&" + params.join("&");
          }
        }
        return url;
      }

      async function translateText(text, targetLang, translationEngine) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000);
        try {
          let response, data, translated = '';
          if (translationEngine === 'mymemory') {
            response = await fetch(
              `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=zh|${targetLang}`,
              { signal: controller.signal }
            );
            clearTimeout(timeoutId);
            if (!response.ok) throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
            data = await response.json();
            translated = data.responseData?.translatedText || 'ç¿»è¯‘å¤±è´¥';
          } else if (translationEngine === 'google') {
            const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=zh-CN&tl=${targetLang}&dt=t&q=${encodeURIComponent(text)}`;
            response = await fetch(url, { signal: controller.signal });
            clearTimeout(timeoutId);
            if (!response.ok) throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
            data = await response.json();
            translated = data[0]?.[0]?.[0] || 'ç¿»è¯‘å¤±è´¥';
          } else {
            throw new Error('æœªçŸ¥ç¿»è¯‘å¼•æ“');
          }
          translated = translated.replace(/<ex[^>]*\/>/g, '').trim();
          return translated;
        } catch (error) {
          clearTimeout(timeoutId);
          throw new Error(`ç¿»è¯‘é”™è¯¯: ${error.message}`);
        }
      }

      function initSearchEngineSelect() {
        const select = dom.searchEngineSelect;
        select.innerHTML = '<option value="all">é€‰æ‹©æœç´¢å¼•æ“ï¼ˆé»˜è®¤æœç´¢å…¨éƒ¨ç»“æœï¼‰</option>';
        Object.entries(searchEngines).forEach(([key, engine]) => {
          const option = document.createElement('option');
          option.value = key;
          option.textContent = engine.name;
          select.appendChild(option);
        });
      }

      function renderConfigList() {
        dom.configList.innerHTML = Object.entries(searchEngines).map(([key, engine]) => `
          <label>
            <input type="checkbox" value="${key}" ${engine.enabled ? 'checked' : ''}>
            ${engine.name}
          </label>
        `).join('');
      }

      // è‡ªåŠ¨è¡¥å…¨
      dom.inputText.addEventListener('input', debounce((e) => {
        const query = e.target.value.trim();
        if (!query) {
          dom.autocompleteList.style.display = 'none';
          return;
        }
        const historySuggestions = historyData.map(item => item.text);
        const corrections = getSpellingSuggestions(query);
        const suggestions = Array.from(new Set([...historySuggestions, ...staticSuggestions, ...trendingSuggestions, ...corrections]));
        const filtered = suggestions.filter(item => item.includes(query));
        if (filtered.length) {
          dom.autocompleteList.innerHTML = filtered.map(item => `
            <div class="autocomplete-item" tabindex="0">${escapeHtml(item)}</div>
          `).join('');
          dom.autocompleteList.style.display = 'block';
        } else {
          dom.autocompleteList.style.display = 'none';
        }
      }, 300));

      dom.inputText.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowDown') {
          const firstItem = dom.autocompleteList.querySelector('.autocomplete-item');
          if (firstItem) {
            firstItem.focus();
            e.preventDefault();
          }
        }
      });
      dom.autocompleteList.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowDown') {
          const next = e.target.nextElementSibling;
          if (next) {
            next.focus();
          }
          e.preventDefault();
        } else if (e.key === 'ArrowUp') {
          const prev = e.target.previousElementSibling;
          if (prev) {
            prev.focus();
          } else {
            dom.inputText.focus();
          }
          e.preventDefault();
        } else if (e.key === 'Enter' || e.key === ' ') {
          if (e.target.classList.contains('autocomplete-item')) {
            dom.inputText.value = e.target.textContent;
            dom.autocompleteList.style.display = 'none';
            e.preventDefault();
          }
        }
      });
      dom.autocompleteList.addEventListener('click', e => {
        if (e.target.classList.contains('autocomplete-item')) {
          dom.inputText.value = e.target.textContent;
          dom.autocompleteList.style.display = 'none';
        }
      });
      dom.clearInputButton.addEventListener('click', () => {
        dom.inputText.value = '';
        dom.autocompleteList.style.display = 'none';
      });

      // é«˜çº§æœç´¢è®¾ç½®æŠ˜å 
      dom.toggleAdvancedBtn.addEventListener('click', () => {
        if (dom.advancedOptions.style.display === 'none' || dom.advancedOptions.style.display === '') {
          dom.advancedOptions.style.display = 'block';
          dom.toggleAdvancedBtn.textContent = 'éšè—é«˜çº§æœç´¢è®¾ç½®';
        } else {
          dom.advancedOptions.style.display = 'none';
          dom.toggleAdvancedBtn.textContent = 'æ˜¾ç¤ºé«˜çº§æœç´¢è®¾ç½®';
        }
      });

      // ç•Œé¢è®¾ç½®æŠ˜å ï¼ˆåŸä½ç½®ï¼‰
      dom.toggleUIBtn.addEventListener('click', () => {
        if (dom.uiSettings.style.display === 'none' || dom.uiSettings.style.display === '') {
          dom.uiSettings.style.display = 'block';
          dom.toggleUIBtn.textContent = 'éšè—ç•Œé¢è®¾ç½®';
        } else {
          dom.uiSettings.style.display = 'none';
          dom.toggleUIBtn.textContent = 'æ˜¾ç¤ºç•Œé¢è®¾ç½®';
        }
      });

      // ç¿»è¯‘å¹¶æ„é€ æœç´¢é“¾æ¥
      dom.translateButton.addEventListener('click', async () => {
        const text = dom.inputText.value.trim();
        if (!text) return alert('è¯·è¾“å…¥æœç´¢å†…å®¹');
        dom.translateButton.disabled = true;
        dom.loadingSpinner.style.display = 'block';
        try {
          const language = dom.searchEngineSelect.value;
          const translationEngine = dom.translationEngineSelect.value;
          let results = [];
          if (language === 'all') {
            results = await Promise.all(
              Object.values(searchEngines)
                .filter(engine => engine.enabled)
                .map(engine =>
                  translateText(text, engine.lang, translationEngine)
                    .then(translated => ({ engine, translated, error: null }))
                    .catch(error => ({ engine, translated: null, error: error.message }))
                )
            );
          } else {
            const engine = searchEngines[language];
            let translated, error = null;
            try {
              translated = await translateText(text, engine.lang, translationEngine);
            } catch(err) {
              error = err.message;
              translated = '';
            }
            results.push({ engine, translated, error });
          }
          dom.outputDiv.innerHTML = results.map(({ engine, translated, error }) => `
            <div class="translation-item">
              <p>${engine.name}ï¼š${error ? `<span style="color: red;">${escapeHtml(error)}</span>` : escapeHtml(translated)}</p>
              <a class="search-link" href="${buildSearchUrl(engine, translated)}" target="_blank">ç«‹å³æœç´¢</a>
              <button class="favorite-button" data-engine="${engine.name}" data-query="${translated}" data-url="${buildSearchUrl(engine, translated)}">æ”¶è—</button>
            </div>
          `).join('');
          saveToHistory(text, language);
          if (dom.outputDiv.innerHTML.trim() !== "") {
            document.documentElement.style.overflowY = "auto";
            document.body.style.overflowY = "auto";
          }
        } catch (error) {
          alert(error.message);
        } finally {
          dom.translateButton.disabled = false;
          dom.loadingSpinner.style.display = 'none';
        }
      });

      // æ”¶è—ä¸åˆ é™¤æ”¶è—
      document.addEventListener('click', (e) => {
        if (e.target.classList.contains('favorite-button')) {
          const result = {
            engine: e.target.dataset.engine,
            query: e.target.dataset.query,
            url: e.target.dataset.url
          };
          saveFavorite(result);
        } else if (e.target.classList.contains('delete-favorite')) {
          const index = parseInt(e.target.dataset.index);
          favoritesData.splice(index, 1);
          localStorage.setItem("favorites", JSON.stringify(favoritesData));
          renderFavorites();
        }
      });
      dom.clearHistoryButton.addEventListener('click', () => {
        historyData = [];
        localStorage.removeItem("history");
        renderHistory();
      });
      dom.clearFavoritesButton.addEventListener('click', () => {
        favoritesData = [];
        localStorage.removeItem("favorites");
        renderFavorites();
      });
      dom.historyList.addEventListener('click', e => {
        if (e.target.classList.contains('delete-history')) {
          const index = parseInt(e.target.dataset.index);
          historyData.splice(index, 1);
          localStorage.setItem("history", JSON.stringify(historyData));
          renderHistory();
        } else if (e.target.closest('.history-item')) {
          const item = historyData[parseInt(e.target.closest('.history-item').dataset.index)];
          dom.inputText.value = item.text;
          dom.searchEngineSelect.value = item.language;
        }
      });
      dom.configBtn.addEventListener('click', () => {
        renderConfigList();
        dom.configModal.style.display = 'flex';
        dom.configModal.querySelector('input, button').focus();
      });
      dom.modalClose.addEventListener('click', () => {
        dom.configModal.style.display = 'none';
      });
      dom.saveConfigBtn.addEventListener('click', () => {
        const checkboxes = dom.configList.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
          searchEngines[checkbox.value].enabled = checkbox.checked;
        });
        const configToSave = {};
        Object.entries(searchEngines).forEach(([key, engine]) => {
          configToSave[key] = { enabled: engine.enabled };
        });
        localStorage.setItem("searchEnginesConfig", JSON.stringify(configToSave));
        dom.configModal.style.display = 'none';
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && dom.configModal.style.display === 'flex') {
          dom.configModal.style.display = 'none';
        }
      });
      // UIè®¾ç½®ï¼šä¸»é¢˜åˆ‡æ¢ä¸å­—ä½“å¤§å°è°ƒèŠ‚
      dom.toggleThemeButton.addEventListener('click', () => {
        document.body.classList.toggle('light-mode');
      });
      dom.fontSizeRange.addEventListener('input', (e) => {
        document.documentElement.style.fontSize = e.target.value + 'px';
      });
      initSearchEngineSelect();
      renderHistory();
      renderFavorites();
      
      // äº‹ä»¶å§”æ‰˜ï¼šç‚¹å‡»æœç´¢é“¾æ¥æˆ–æ”¶è—æŒ‰é’®åæ·»åŠ  .clicked ç±»
      document.body.addEventListener('click', function(e) {
        if (e.target.matches('.search-link, .favorite-button')) {
          e.target.classList.add('clicked');
        }
      });
      
    })();
  </script>
</body>
</html>
